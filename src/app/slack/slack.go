package slack

import (
	"bytes"
	"encoding/json"
	"net/http"
	"os"
	"time"
)

func GetWebhookURL() string {
	return os.Getenv("SLACK_WEBHOOK_URL")
}

type Payload struct {
	Username   string `json:"username"`
	Text       string `json:"text"`
	IsMarkdown bool   `json:"mrkdwn"`
}

func NewPayload(cve, summary string) Payload {
	return Payload{
		Username:   cve,
		Text:       summary,
		IsMarkdown: false,
	}
}

type Client struct {
	*http.Client
	url string
}

func NewClient(url string) *Client {
	return &Client{
		Client: &http.Client{
			Timeout: time.Second * 10,
		},
		url: url,
	}
}

func (c *Client) Post(p Payload) error {
	b := new(bytes.Buffer)
	if err := json.NewEncoder(b).Encode(p); err != nil {
		return err
	}

	res, err := c.Client.Post(c.url, "application/json", b)
	if err != nil {
		return err
	}
	_ = res
	return nil
}
